# 操作系统（二）

> 第二天，加油！

## 操作系统的逻辑结构

- 整体式结构

  - 以模块为基本单位构建

    ![image-20191201093347038](/home/vophan/.config/Typora/typora-user-images/image-20191201093347038.png)

    - 模块设计，编码，调试独立
    - 模块调用自由
    - 模块通信多以全局变量形式完成
    - 缺点：信息传递随意，维护和更新难，适合小系统

- 层次结构

  - 例子：TCP/IP协议栈

    ![image-20191201093707697](/home/vophan/.config/Typora/typora-user-images/image-20191201093707697.png)

  - 所有功能按照调用次序排成若干层，只有单向依赖或者调用

  - 优点：

    - 结构清晰，避免循环调用
    - 整体问题局部话
    - 有利于系统的维护，扩充，移植

- 微内核结构

  - 操作系统 = 微内核 + 核外服务器
  - 微内核：
    - 足够小，只提供最基础的核心功能和服务
  - 核外服务器
    - 完成绝大多数任务
    - 由若干个服务器或者进程构成，进程/线程服务器，虚存服务器....

linux是典型的单体内核，minux是典型的微内核结构

## CPU的态

- 支持操作系统的最基础的硬件结构
  - CPU
  - 内存
  - 中断
  - 时钟
- CPU Mode（态）
  - CPU的工作状态
  - 对资源的指令使用权限的描述
  - 特权指令，高态才能使用
  - 态：
    - 核态
      - 访问所有资源与指令
      - 管理程序和OS内核
    - 用户态（目态）
      - 仅能访问
      - 用户程序
    - 管态
      - 介于两者中间
  - 用户态转换为核态
    - 用户请求OS提供服务
    - 发生中断
    - 用户进程出现错误（内部中断）
    - 用户态想要调用特权指令
  - 核态转换为用户态
    - 执行中断返回：IRET
  - 硬件按照态来区分CPU的状态
  - OS按进程区分CPU状态
  - Intel CPU的态：Ring0-Ring3
    - 不同程序段都有自己的请求特权级，RPL，描述符特权级
    - 程序段A访问程序段B的时候，会进行权限检查

## 存储器

- 分类：
  - 存储器工作方式：
    - RAM
    - ROM
  - 按存储元的材料
    - 半导体
    - 磁
    - 光
  - 与CPU的交互
    - 主存
    - 辅存
- 分级储存系统的工作原理
  - 访问缓存（命中 hit）
  - 访问内存（没有命中， MISS）
  - 访问辅存（缺页，PAGE_FAULT）

## 中断机制

> CPU对外部事件的反应机制

- 引入中断的意义
  - 实现并发活动
  - 实现实时处理
  - 故障的自动处理
- 时钟产生中断，实现实时处理
- 中断源与中断类型
  - 类型：
    - 强迫性中断：程序没有预期：IO， 外部中断
    - 自愿中断：程序里写好的：访管中断
  - 也可以分成：
    - 外中断：CPU外部事件引起
    - 内中断：CPU内部事件引起
  - 不可屏蔽中断和可屏蔽中断
    - 不可：CPU必须响应
    - 可：CPU可不响应
- 断点
  - 程序中断的地方，将要执行的下个指令的地址
  - 存放在CS:IP
- 现场
  - 程序正确运行的依赖的集合
- 现场的两个处理过程
  - 现场数据的保护：进入中断服务程序前，将现场保存到栈中
  - 现场数据的恢复：退出中断程序之前
- 中断处理响应过程：
  - 识别中断源
  - 保护断电与现场
  - 装入中断服务程序的入口地址（CS：IP）
  - 进入中断服务程序
  - 恢复现场与断点
  - 中断返回
- 中断处理的实质
  - 交换指令执行地址（CS:IP）
  - 交换CPU的态（中断响应程序在核态完成）































